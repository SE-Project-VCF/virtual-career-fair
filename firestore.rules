service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------
    // USERS COLLECTION
    // --------------------------
    match /users/{userId} {
      // Allow authenticated users to create their own user document during registration
      allow create: if request.auth != null && 
                     request.auth.uid == userId &&
                     (request.resource.data.role == "student" ||
                      request.resource.data.role == "companyOwner" ||
                      request.resource.data.role == "representative");
      
      // Allow authenticated users to read any user document (needed for invite code validation)
      // This allows querying the users collection to find employers by inviteCode
      allow read: if request.auth != null;
      
      // A user can write (update/delete) their own data
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --------------------------
    // COMPANIES COLLECTION
    // --------------------------
    match /companies/{companyId} {
      // Allow authenticated users to read companies (for invite code validation)
      allow read: if request.auth != null;
      
      // Company owners can create companies
      allow create: if request.auth != null && 
                     request.resource.data.ownerId == request.auth.uid;
      
      // Company owners and representatives can update their companies
      // Also allow adding yourself to representativeIDs (for new rep registration)
      // Note: arrayUnion operations - allow if user is not already in array and critical fields unchanged
      allow update: if request.auth != null && 
                     (resource.data.ownerId == request.auth.uid ||
                      request.auth.uid in resource.data.representativeIDs ||
                      // Allow adding yourself during registration
                      // Check that user isn't already a rep and critical fields aren't being modified
                      (!(request.auth.uid in resource.data.representativeIDs) &&
                       request.resource.data.ownerId == resource.data.ownerId &&
                       request.resource.data.companyName == resource.data.companyName));
      
      // Only company owners can delete their companies
      allow delete: if request.auth != null && 
                     resource.data.ownerId == request.auth.uid;
    }

    // --------------------------
    // JOBS COLLECTION
    // --------------------------
    match /jobs/{jobId} {
      allow read: if request.auth != null; // Everyone logged in can view
      allow create, update, delete: if request.auth != null
        && exists(/databases/$(database)/documents/companies/$(request.auth.uid));
    }

    // --------------------------
    // BOOTHS COLLECTION
    // --------------------------
    match /booths/{boothId} {
      allow read: if request.auth != null; // Everyone logged in can view
      allow create, update, delete: if request.auth != null
        && exists(/databases/$(database)/documents/companies/$(request.auth.uid));
    }

    // --------------------------
    // DEFAULT DENY (Everything else)
    // --------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

